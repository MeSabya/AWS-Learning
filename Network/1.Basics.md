# Amazon VPC And Its Types

A VPC is a virtual network specific to you within AWS for you to hold all your AWS services. It is a logical data center in AWS and will have gateways, route tables, network access control lists (ACL), subnets and security groups.

**Things to note:**
- Each subnet exists within 1 availability zone.
- Security groups are stateful, ACL‚Äôs are stateless
- VPC‚Äôs can be peered within the same account and across AWS accounts
- Transitive peering is not allowed, meaning you cant hop from one VPC to another, via another VPC. You must have direct access.
- The region has more than one AZ.
- AZ belongs only to one region
- AZ has more than one data center
- AZ can have more than one subnets. However, there is a soft limit of 200 subnets per AZ. You can ask Amazon for more than 200 if you need.
- Subnet belongs only to one AZ
- VPC belongs only to one region. You can have more than one VPC per region. However, there is a soft limit of 5 VPCs per region. You can ask Amazon for more than 5 if you need.
- VPC can span more than one AZ.

## Why use a VPC?

üëâ When you open up a service within a public cloud, it is effectively open to the world and can be at risk to attacks from the internet. In order to lock your instances down and secure them against attacks from the outside, you lock them within a VPC. The VPC restricts what sort of traffic, IP addresses and also the users that can access your instances.

üëâ This prevents unwanted guests accessing your resources and secures you from things like DDOS attacks. Not all services require access to the internet, so those can be locked away safely within a private network. You can then expose only certain machines to the internet.

## NAT Instances

üëâ **A NAT instance can be used to solve the problem ‚Äúhow do I install things from the internet on my secured private instances‚Äù?**

üëâ A NAT instance is created in a public subnet with access to the internet. Once you allow access from your private instance to your NAT, your private instance will then be able to make requests to the internet. This access is one way i.e. someone from the internet cannot access your instance.

**Things to note:**

- A NAT instance must be in a public subnet.
- It must have an Elastic IP
- There must be a route from your private subnet into the NAT instance
- You can manually create high availability using Autoscaling groups and multiple subnets
- Different to a Bastian because a NAT is used to provide internet access to private instances, a Bastian is used to administer instance using SSH for example.
- They are now sort of deprecated and replaced with NAT Gateways

![image](https://user-images.githubusercontent.com/33947539/152124132-6771dc60-c0cb-4c1c-b7d6-f020c9e79404.png)

## NAT Gateways
NAT Gateways have basically replaced NAT instances as they allow the same access to the internet from a private subnet with the same security. However, they are much easier to set up and scale, as this is all managed by Amazon.

**Things to note:**

- Scale automatically up to 10Gbps
- No need to manually patch ‚Äî amazon takes care of this
- Not associate with security groups
- automatically assigned a public IP

üëâ *A NAT Gateway connects to a specific Subnet, and a Subnet is in a specific Availability Zone.*

Amazon EC2 instances in private subnets can use a NAT Gateway as follows:

The NAT Gateway is launched in a public subnet in the same VPC
The Route Table for the private subnet(s) require an additional entry that directs all Internet-bound traffic (0.0.0.0/0) to the NAT Gateway
Depending upon your appetite for risk, you might configure things differently.

**Case 1: One public subnet, one private subnet in same AZ**

The NAT Gateway goes into the public subnet
The EC2 Instances go into the private subnet
The Route Table for the private subnet points to the NAT Gateway in the public subnet

**Case 2: Two public subnets, two private subnets, one NAT Gateway**
The NAT Gateway goes into one public subnet (Public-Subnet-A)
The EC2 instances are launched in private subnets across two AZs (Private-Subnet-A, Private-Subnet-B)
The Route Table for both of the private subnets point to the NAT Gateway
However, if there is a failure with Availability Zone A (rare, but can happen), then the NAT Gateway is not reachable from Private-Subnet-B. Thus, the system may be impacted even though it is running across two AZs.

**Case 3: Two public subnets, two private subnets, two NAT Gateways**

The NAT Gateway goes into both public subnets (Public-Subnet-A, Public-Subnet-B)
The EC2 instances are launched in private subnets across two AZs (Private-Subnet-A, Private-Subnet-B)
The Route Table Private-Subnet-A points to the NAT Gateway in Public-Subnet-A
The Route Table Private-Subnet-B points to the NAT Gateway in Public-Subnet-B
If one of the AZs were to fail, then the EC2 instances in the other private subnet will still be able to communicate with the Internet because they have their own NAT Gateway in the same AZ.



## Network Access Control Lists (ACL)

üëâ By default, a VPC will come with a Network ACL and it will allow all inbound and outbound traffic. However, if you create a default Network ACL, it will block all inbound and outbound traffic, and you will have to manually allow traffic yourself.

üëâ Each subnet within a VPC must be connected to a Network ACL, however, each subnet can only be connected to 1 VPC at a time. The ACL, however, can be connected to multiple different subnets.

**Things to remember:**

- The Network ACL contains an ordered list of rules to allow traffic
- The convention is to start from 100 rules and go up in increments of 100.
- The rules will be considered in order to make sure if you want to allow all ssh access apart from a certain IP address, that you add your block rule before your allow all rule.
- There are separate rules for inbound and outbound traffic, so you must set up rules for each.
- They are stateless meaning responses to inbound traffic are dependent on outbound traffic rules and this applies the other way around.
- Block IP address using Network ACL‚Äôs and not Security groups

## What are subnets?

üëâ A subnet, or sub-network, is the result of splitting up an IP network by IP address.

An IP address, of course, consists of 4 numbers between 0 and 255, such as:

255.255.255.255

This allows up to ‚Ä≠4,294,967,296‚Ä¨ different addresses, at least with IPv4, which is what we‚Äôre concentrating on in this article. Since an IP address consists of 32 bits, you can also think of this as 2^32, which represents the same number.

- *You can create a VPC that spans multiple Availability Zones. After creating a VPC, you can add one or more subnets in each Availability Zone. Each subnet must reside   
  exclusively within one Availability Zone and cannot span zones. AWS assigns a unique ID to each subnet.*
  
- If a subnet‚Äôs traffic is routed to an Internet gateway, the subnet is known as a **Public subnet**. If the instance in a Public subnet needs to communicate with the Internet,   it must have a public IP address or an Elastic IP address. If a subnet doesn‚Äôt have a direct route to the Internet gateway, the subnet is known as a **Private subnet.**

- When you create a subnet, you specify the CIDR block for the subnet. The CIDR block of a subnet can be the same as the CIDR block for the VPC (for a single subnet in the VPC), 
  or a subset (to enable multiple subnets). The allowed block size is between a /28 netmask and /16 netmask. You can create more than one subnet in a VPC, but the CIDR blocks of 
  the subnets must not overlap.

  ![image](https://user-images.githubusercontent.com/33947539/152145426-20a00626-5d27-4edc-9417-bfb594023fd7.png)

### What situations warrant a different subnet?

#### 1. Deploying to different AWS availability zones

An availability zone is a geographically and operationally separate AWS data centre within the same AWS region. This means that if one availability zone goes down there will be another available to take over.

To achieve high availability it‚Äôs always recommended to deploy services to at least two availability zones.

In AWS, though, a subnet can only span one availability zone. This means that to achieve high availability you must deploy services to multiple subnets.

Consider the example below, where we have a VPC in eu-west-1. In order to deploy services into multiple availability zones we can create two subnets, one in eu-west-1a and the other in eu-west-1b.

![image](https://user-images.githubusercontent.com/33947539/152145745-881f0224-45e0-42b3-a7e5-800ddda207b2.png)

#### 2. Securing your AWS resources within a private subnet

To provide internet access to a subnet we need an AWS Internet Gateway. A subnet can then be attached to a route table which contains a route to that internet gateway. That subnet then becomes a public subnet.

If, on the other hand, another subnet is attached to a route table that doesn‚Äôt contain a route via the internet gateway, it‚Äôs a private subnet.

#### 3. Using AWS Elastic Load Balancers
Elastic Load Balancers come in two flavours:

Network Load Balancers
Application Load Balancer
If you want to use the Application Load Balancer, which is a layer 7 HTTP load balancer, you‚Äôll need to configure at least two subnets. Or more specifically, you need to specify subnets from at least two availability zones.

AWS don‚Äôt provide any clear reason why this is, and the Network Load Balancer doesn‚Äôt have such a constraint.

## Firewalls:
üëâ A firewall allows or denies ingress traffic and egress traffic. We can define rules to allow or deny inbound traffic or similarly we can allow or deny outbound traffic.

üëâ In AWS Network ACLs and Security groups both act as a firewall.

Network ACLs: Network ACLs are stateless firewalls and works on the subnet level.

Security groups: Security groups are stateful firewalls and work on instance level.



